function _getDate(e){var t=new Array("января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"),i=e.getDate(),n=e.getMonth(),o=e.getFullYear();return i+" "+t[n]+" "+o}function _getTime(e){var t=e.getHours(),i=e.getMinutes();return 10>i&&(i="0"+i),t+":"+i}function showCommentForm(e,t){$("#commentParentId").val(t),$("#commentForm").insertAfter(e)}function addToFavorite(e){var t=$(this);App.User.runIfAuth(function(){Api.post("/api.article.favorite",{id:t.data("id")},function(e){t.parent().html(e.content)})},"Вы должны авторизоваться")}var App={Controllers:{_controllers:[],add:function(e,t){if("function"!=typeof t)return this;if("object"==typeof e)for(var i=0;i<e.length;i++)this._controllers.push([e[i],t]);else"string"==typeof e&&this._controllers.push([e,t]);return this},call:function(){for(var e=$("body:first").attr("id"),t=0;t<this._controllers.length;t++)e=="body."+this._controllers[t][0]&&this._controllers[t][1](this._controllers[t][0])}},Components:{_elements:[],_modules:[],add:function(e,t,i){return"function"!=typeof t?this:(this._elements.push([e,t,i||0]),this)},addModule:function(e,t,i){return"function"!=typeof t?this:(this._modules.push([e,t,i||0]),this)},call:function(e){for(var t=0;t<this._elements.length;t++){var i=this._elements[t];_.isArray(e)&&-1!=_.indexOf(e,i[0])?i[1]():e==i[0]&&i[1]()}},init:function(e){this._elements=_.sortBy(this._elements,2),this._modules=_.sortBy(this._modules,2);for(i in this._elements){var t=this._elements[i];try{e?_.isArray(e)&&-1!=_.indexOf(e,t[0])?t[1]():e==t[0]&&t[1]():t[1]()}catch(n){console.log(t[0],n)}}var o=[];$("[data-module]").each(function(){o.push($(this).data("module"))}),o=_.uniq(o);for(i in this._modules){var e=this._modules[i],a=e[0];-1!=_.indexOf(o,a)&&e[1]()}}},Messages:{init:function(){"undefined"!=typeof MESSAGE_ERRORS&&(this.parse(MESSAGE_ERRORS,"error"),this.parse(MESSAGE_SUCCESS),$("body").on("show_message",$.proxy(function(){var e=_.toArray(arguments).slice(1);this.parse(e)},this)))},parse:function(e,t){for(text in e)"_external"!=text?this.show(e[text],t):this.parse(e[text],t)},show:function(e,t,i){t||(t="success"),window.top.noty({layout:"topRight",type:t,icon:i||"fa fa-ok",text:decodeURIComponent(e)})},error:function(e){this.show(e,"error")}},Dialog:{confirm:function(e,t,i,n){bootbox.confirm({title:i||"Подтверждение действия",message:e,className:"modal-alert modal-warning",closeButton:!1,callback:function(e){e&&t()},buttons:{confirm:{label:"Да",className:"btn-success btn-lg"},cancel:{label:"Нет",className:"btn-default btn-lg"}}})}},Loader:{counter:0,getLastId:function(){return this.counter},init:function(e,t){void 0===e||e instanceof jQuery?void 0===e&&(e=$("body")):e=$(e),++this.counter;var i=$('<div class="_loader_container"><span class="_loader_preloader" /></div>');return void 0!==t&&(t instanceof jQuery?i.append(t):i.append('<span class="_loader_message">'+t+"</span>")),i.appendTo(e).css({width:e.outerWidth(!0),height:e.outerHeight(!0),top:e.offset().top-$(window).scrollTop(),left:e.offset().left-$(window).scrollLeft()}).prop("id","loader"+this.getLastId())},show:function(e,t,i){var i=i||500;return this.init(e,t).fadeTo(i,.7),this.counter},hide:function(e){e?cont=$("#loader"+e):cont=$("._loader_container"),cont.stop().fadeOut(400,function(){$(this).remove()})}}};App.User={checkAuth:function(){return USER_ID},runIfGuest:function(e,t){this.checkAuth()||"function"!=typeof e||e(),t&&App.Messages.error(t)},runIfAuth:function(e,t){return this.checkAuth()&&"function"==typeof e?e():void(t&&App.Messages.error(t))}},App.Form={extend:function(e,t){if(!t)var t={};return t._prefix=e,App.Form[e]=$.extend({},this._decorator,t),App.Form[e]},_decorator:{_id:null,_api_url:null,_api_method:null,_prefix:null,_key:null,_timestamp:null,_isChanged:!1,_form:null,_autoSaveTimer:null,_fieldsData:{},_submitButton:null,messages:{saved:null},fieldsMeta:{},_fields:{},autoSaveDelay:5e3,init:function(e){if(this._form=e,this._key="form"+this._prefix+this._id,$(this._form).on("click",":button",$.proxy(function(e){this._submitButton=$(e.target)},this)),this._fieldsData.timestamp=(new Date).getTime(),(null===this._api_url||!this._api_url.length)&&this._form.attr("action").indexOf("api.")>=0&&(this._api_url=this._form.attr("action")),null===this._api_method||!this._api_method.length){var t=$('input[name="_method"]',this._form);this._api_method=t.size()?t.val().toLowerCase():this._form.prop("method").toLowerCase()}this._autoSaveTimer=setInterval($.proxy(this.onBackup,this),this.autoSaveDelay),this._id=this._fieldsData.id;for(i in this.fieldsMeta)this.fieldsMeta[i]in App.Form.Field?this._fields[i]=Object.create(App.Form.Field[this.fieldsMeta[i]]):this._fields[i]=Object.create(App.Form.Field["default"]),this._fields[i].init(this,i);console.log(this._fields),this.getFieldsData(),this.onLoad(),$(window).unload($.proxy(this.onUnload,this))},getFieldsData:function(){for(i in this._fields)this._fieldsData[i]=this._getFieldData(i);return this._fieldsData},setFieldsData:function(e){for(i in this._fields)"id"!=i&&this._setFieldData(i,e[i])},getField:function(e){return this._fields[e]||null},hasField:function(e){return e in this.fieldsMeta},_getFieldData:function(e){return this.hasField(e)?this.getField(e).getValue():!1},_setFieldData:function(e,t){return this.hasField(e)?this.getField(e).setValue(t):!1},saveToLocalStorage:function(e){$.jStorage.set(this._key,e),this._isChanged=!1},getFromLocalStorage:function(){return $.jStorage.get(this._key)},clearLocalStorage:function(){$.jStorage.deleteKey(this._key)},clearErrors:function(){$(".validation-error").remove(),$(".form-group").removeClass("has-error")},onFailValidation:function(e){for(field in e)if(this.hasField(field)){var t=this.getField(field).getElement();t.closest(".form-group").addClass("has-error").end();for(i in e[field])t.after($('<p class="help-block validation-error" />').text(e[field][i]))}},onLoad:function(){this._form.on("submit",$.proxy(this.onSubmit,this)).on("change keyup","input, select, textarea",$.proxy(this.onChange,this)),this.showAutoSaveNotify()},onChange:function(e){e.preventDefault(),this._isChanged=!0,$("#notification_autosave").remove()},onSubmit:function(e){return this.clearErrors(),$(":button",this._form).prop("disabled",!0),this._api_url?(e.preventDefault(),Api[this._api_method](this._api_url,this.getFieldsData(),$.proxy(this.onResponse,this)),!1):void 0},onResponse:function(e){$(":button",this._form).prop("disabled",!1),this.clearLocalStorage()},showAutoSaveNotify:function(){var e=this.getFromLocalStorage();if(_.isObject(e)&&!_.isEmpty(e)){var t=new Date(e.timestamp);this._form.prepend(_.template('<div class="alert alert-info m-b-none" id="notification_autosave">У вас есть автосохранение от <b><%= date %> <%= time %></b>, <a href="#reset" class="reset_form_from_autosave">восстановить форму</a>?</div>')({date:_getDate(t),time:_getTime(t)})),$(".reset_form_from_autosave").on("click",$.proxy(function(t){t.preventDefault(),this.onRestore(e),$("#notification_autosave").remove()},this))}},onBackup:function(e){if(this._isChanged){var t=this.getFieldsData();t.timestamp=(new Date).getTime(),this.saveToLocalStorage(t)}},onRestore:function(e){this.setFieldsData(e)},onUnload:function(e){this.onBackup(e)}}},App.Form.Field={extend:function(e,t){if(!t)var t={};return t._prefix=e,App.Form.Field[e]=$.extend({},this._decorator,t),App.Form.Field[e]},_decorator:{_form:null,_name:null,_element:null,init:function(e,t){return this._form=e,this._name=t,this._element=this.getFieldInput(),this._init(),this},getFieldInput:function(){return $(':input[name="'+this.getName()+'"]',this._form._form)},getElement:function(){return this._element},getValue:function(){return this.getElement().val()},setValue:function(e){this.getElement().val(e)},getName:function(){return this._name},_init:function(){}}},App.Form.Field.extend("default"),App.Form.Field.extend("checkbox",{getFieldInput:function(){return $(':input[name="'+this.getName()+'"]:not(:hidden)',this._form._form)},getValue:function(){return this.getElement().prop("checked")},setValue:function(e){return this.getElement().prop("checked",e).trigger("change")}}),App.Form.Field.extend("markdown",{_init:function(){var e=this.getElement();this.editor=new SimpleMDE({element:e[0],spellChecker:!1})},getValue:function(){return this.editor.value()},setValue:function(e){return this.editor.value(e)}}),App.Form.Field.extend("tags",{_init:function(){this.getElement().tagsinput({minLength:2,confirmKeys:[13,44],trimValue:!0,freeInput:!0,typeahead:{afterSelect:function(e){this.$element.val("")},source:function(e){return $.get("/api.tags.search",{query:e})}}})},setValue:function(e){return this.getElement().tagsinput("add",e)}}),App.Form.Field.extend("rangeslider",{_init:function(){this.slider=$("<div />").insertBefore(this.getElement())[0];var e=this;noUiSlider.create(this.slider,{start:this.getElement().val()||0,step:this.getElement().data("step")||1,range:this.getElement().data("range")||{min:[0],max:100}}),this.slider.noUiSlider.on("update",function(t,i){$("#slider-"+e.getName()+" .slider-value").text(t[i]),e.getElement().val(t[i])})},getValue:function(){return this.slider.noUiSlider.get()},setValue:function(e){return this.slider.noUiSlider.set(e)}});var Api={_response:null,get:function(e,t,i,n){return this.request("GET",e,t,i,n)},post:function(e,t,i,n){return this.request("POST",e,t,i,n)},put:function(e,t,i,n){return this.request("PUT",e,t,i,n)},"delete":function(e,t,i,n){return this.request("DELETE",e,t,i,n)},request:function(e,t,i,n,o){var a=this.parseUrl(t);return $.ajaxSetup({contentType:"application/json"}),i instanceof jQuery&&(i=Api.serializeObject(i)),"object"==typeof i&&"get"!=e.toLowerCase()&&(i=JSON.stringify(i)),$.ajax({type:e,url:a,data:i,dataType:"json",async:o!==!1}).done(function(t){return this._response=t,200!=t.code?Api.exception(t,n):(window.top.$("body").trigger(Api.getEventKey(e,a),[this._response]),t.message&&200==t.code&&App.Messages.show(t.message,"information"),t.popup&&200==t.code&&Popup.openHTML(t.popup),void("function"==typeof n&&n(this._response)))}).fail(function(e){return Api.exception(e.responseJSON,n)})},parseUrl:function(e){return e},getEventKey:function(e,t){var i=e+t.replace(SITE_URL,":").replace(/\//g,":");return i.toLowerCase()},serializeObject:function(e){var t={},i={},n={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/},o=function(e,t,i){return e[t]=i,e},a=function(e){return void 0===i[e]&&(i[e]=0),i[e]++};return $.each(e.serializeArray(),function(){if(n.validate.test(this.name)){for(var e,i=this.name.match(n.key),s=this.value,r=this.name;void 0!==(e=i.pop());)r=r.replace(new RegExp("\\["+e+"\\]$"),""),e.match(n.push)?s=o([],a(r),s):e.match(n.fixed)?s=o([],e,s):e.match(n.named)&&(s=o({},e,s));t=$.extend(!0,t,s)}}),t},exception:function(e,t){switch("function"==typeof t&&t(e),e.code){case 220:break;case 110:App.Messages.show(e.message,"error","fa fa-exclamation-triangle");break;case 120:for(i in e.errors)App.Messages.show(e.errors[i],"error","fa fa-exclamation-triangle");break;case 130:case 140:case 150:break;case 301:case 302:window.location.href=e.targetUrl;break;case 403:case 404:break;default:App.Messages.show(e.message,"error","fa fa-exclamation-triangle")}},response:function(){return this._response}};App.Components.add("ajaxSetup",function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}})}).add("notySetup",function(){$.noty.defaults=$.extend($.noty.defaults,{layout:"topRight",theme:"relax",timeout:3e3})}).add("validator.default",function(){"function"==typeof jQuery.fn.validator&&$.validator.setDefaults({highlight:function(e){var t=$(e);t.hasClass("select2-offscreen")?$("#s2id_"+t.attr("id")+" ul").closest(".form-group").addClass("has-error"):t.closest(".form-group").addClass("has-error")},unhighlight:function(e){var t=$(e);t.hasClass("select2-offscreen")?$("#s2id_"+t.attr("id")+" ul").closest(".form-group").removeClass("has-error").find("help-block-hidden").removeClass("help-block-hidden").addClass("help-block").show():t.closest(".form-group").removeClass("has-error").find("help-block-hidden").removeClass("help-block-hidden").addClass("help-block").show()},errorElement:"p",errorClass:"jquery-validate-error help-block",errorPlacement:function(e,t){var i,n,o;return o=t.is('input[type="checkbox"]')||t.is('input[type="radio"]'),n=t.closest(".form-group").find(".jquery-validate-error").length,o&&n?void 0:(n||t.closest(".form-group").find(".help-block").removeClass("help-block").addClass("help-block-hidden").hide(),e.addClass("help-block"),o?t.closest('[class*="col-"]').append(e):(i=t.parent(),i.is(".input-group")?i.parent().append(e):i.append(e)))}})}).add("datepicker",function(){if("function"==typeof jQuery.fn.datetimepicker){var e={format:"Y-m-d H:i:00",lang:LOCALE,dayOfWeekStart:1};$(".input-datetime").each(function(){var t=$.extend({},e),i=$(this);i.data("range-max-input")&&(t.onShow=function(e){var t=$(i.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():!1})}),i.data("range-min-input")&&(t.onShow=function(e){var t=$(i.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():!1})}),i.datetimepicker(t)}),$(".input-date").each(function(){var t=$.extend(e,{timepicker:!1,format:"Y-m-d"}),i=$(this);i.data("range-max-input")?t.onShow=function(e){var t=$(i.data("range-max-input"));this.setOptions({maxDate:t.val()?t.val():!1})}:i.data("range-min-input")&&(t.onShow=function(e){var t=$(i.data("range-min-input"));this.setOptions({minDate:t.val()?t.val():!1})}),i.datetimepicker(t)})}}).add("icon",function(){$("*[data-icon]").add("*[data-icon-prepend]").each(function(){var e=$(this).data("icon");$(this).hasClass("btn-labeled")&&(e+=" btn-label icon"),$(this).html('<i class="icon-'+e+'"></i> '+$(this).html()),$(this).removeAttr("data-icon-prepend").removeAttr("data-icon")}),$("*[data-icon-append]").each(function(){$(this).html($(this).html()+'&nbsp&nbsp<i class="icon-'+$(this).data("icon-append")+'"></i>'),$(this).removeAttr("data-icon-append")})}),App.Form.extend("articles",{fieldsMeta:{title:"string",text_source:"markdown",disable_comments:"checkbox",disable_stat_views:"checkbox",disable_stat_pays:"checkbox",tags:"tags",cost:"rangeslider"},messages:{saved:"Article saved"}}),App.Controllers.add(["article.create","article.edit"],function(e){App.Form.articles.init($("form"))}),App.Controllers.add(["article.index","article.show"],function(){$("body").on("click",".addToFavorite",addToFavorite)}),App.Controllers.add("article.show",function(){$(".commentItem--reply").on("click",function(e){e.preventDefault(),showCommentForm($(this),$(this).data("id"))}),$(".commentForm--title a").on("click",function(e){e.preventDefault(),showCommentForm($(this).parent(),null)}),$("#commentForm").validate({rules:{text:{required:!0,minlength:10},title:{maxlength:255}}})}),$(function(){function e(){App.Components.init(),App.Controllers.call(),App.Messages.init()}$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),e()});